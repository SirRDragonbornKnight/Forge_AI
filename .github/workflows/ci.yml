name: CI

on:
  push:
    branches: [ main, master, develop, copilot/** ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        run: |
          pytest tests/ -v --tb=short --continue-on-collection-errors
      
      - name: Generate coverage report
        run: |
          pytest tests/ --cov=enigma --cov-report=xml --cov-report=term
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.2
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 autopep8 mypy
      
      - name: Lint with flake8 (syntax errors and undefined names)
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          # E9: Runtime errors (syntax errors, indentation errors)
          # F63: Invalid print statement or exec statement
          # F7: Syntax errors in type comments, docstrings
          # F821: Undefined name
          # F822: Undefined name in __all__
          flake8 enigma/ --count --select=E9,F63,F7,F821,F822 --show-source --statistics
      
      - name: Check for unused imports (F401)
        run: |
          # Check that we have no unused imports (warning only)
          flake8 enigma/ --count --select=F401 --statistics || true
      
      - name: Check code style with flake8
        run: |
          # Full style check (exit-zero treats all errors as warnings)
          flake8 enigma/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --show-source
      
      - name: Check for security issues
        run: |
          # Basic security checks - fail if dangerous functions are found
          # Look for eval() function calls (not .eval() method calls)
          if grep -rE '(\s|^|[^\w\.])eval\s*\(' enigma/ 2>/dev/null; then
            echo "ERROR: Found eval() function usage which is a security risk"
            exit 1
          fi
          # Look for exec() function calls (not .exec() method calls)
          if grep -rE '(\s|^|[^\w\.])exec\s*\(' enigma/ 2>/dev/null; then
            echo "ERROR: Found exec() function usage which is a security risk"
            exit 1
          fi
          echo "Security check passed: No dangerous eval() or exec() found"

  build-docs:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Verify documentation exists
        run: |
          test -f README.md || exit 1
          test -f CONTRIBUTING.md || exit 1
          test -f SECURITY.md || exit 1
          echo "Documentation files verified"
