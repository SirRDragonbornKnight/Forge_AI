{% extends "base.html" %}

{% block title %}Chat - Enigma Engine{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h2>Chat Interface</h2>
        <div class="ai-mood" id="chat-ai-mood">
            <span class="mood-text ai-status" id="chat-mood-emoji">[Ready]</span>
            <span class="mood-text" id="chat-mood-text">Ready to chat!</span>
        </div>
    </div>
    
    <div class="chat-box" id="chat-box">
        <div class="chat-message system">
            <p>Hello! I'm your Forge AI. Ask me anything!</p>
        </div>
    </div>
    
    <div class="chat-input-container">
        <textarea id="chat-input" placeholder="Type your message here..." rows="3"></textarea>
        <div class="chat-controls">
            <button id="send-btn" class="btn btn-primary">Send</button>
            <button id="clear-btn" class="btn btn-secondary">Clear</button>
        </div>
    </div>
    
    <div class="chat-settings">
        <label>Max Tokens: <input type="number" id="max-tokens" value="200" min="50" max="500"></label>
        <label>Temperature: <input type="number" id="temperature" value="0.7" min="0" max="2" step="0.1"></label>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const chatBox = document.getElementById('chat-box');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const clearBtn = document.getElementById('clear-btn');

// Load AI mood
async function loadChatMood() {
    try {
        const response = await fetch('/api/ai/mood');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('chat-mood-emoji').textContent = data.emoji;
            document.getElementById('chat-mood-text').textContent = data.text.split('!')[0] + '!';
        }
    } catch (error) {
        console.error('Error loading AI mood:', error);
    }
}

// Try to connect to WebSocket
let socket = null;
try {
    socket = io();
    
    socket.on('connect', () => {
        console.log('Connected to server');
        addSystemMessage('Connected to server');
    });
    
    socket.on('response', (data) => {
        addAIMessage(data.text);
    });
    
    socket.on('token', (data) => {
        // Stream token
        appendToLastMessage(data.token);
    });
    
    socket.on('stream_end', () => {
        // Streaming complete
    });
    
    socket.on('error', (data) => {
        addSystemMessage('Error: ' + data.message);
    });
} catch (error) {
    console.log('WebSocket not available, using REST API');
}

function addMessage(content, className) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${className}`;
    
    let messageHTML = `<p>${content}</p>`;
    
    // Add feedback buttons for AI messages
    if (className === 'ai') {
        messageHTML += `
            <div class="message-feedback">
                <button class="feedback-btn" data-feedback="positive" title="Good response">+1</button>
                <button class="feedback-btn" data-feedback="negative" title="Poor response">-1</button>
                <button class="feedback-btn explain-btn" title="Why did you say that?">?</button>
            </div>
        `;
    }
    
    messageDiv.innerHTML = messageHTML;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // Add feedback listeners
    if (className === 'ai') {
        messageDiv.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.addEventListener('click', () => handleFeedback(btn, content));
        });
    }
    
    return messageDiv;
}

function addUserMessage(text) {
    return addMessage(text, 'user');
}

function addAIMessage(text) {
    return addMessage(text, 'ai');
}

function addSystemMessage(text) {
    return addMessage(text, 'system');
}

function appendToLastMessage(text) {
    const messages = chatBox.querySelectorAll('.chat-message.ai');
    if (messages.length > 0) {
        const lastMessage = messages[messages.length - 1];
        lastMessage.querySelector('p').textContent += text;
        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

async function handleFeedback(btn, messageText) {
    const feedback = btn.dataset.feedback;
    
    if (btn.classList.contains('explain-btn')) {
        // Ask AI to explain
        try {
            const response = await fetch('/api/ai/explain', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({question: 'Why did you say: ' + messageText})
            });
            
            const data = await response.json();
            
            if (data.success) {
                addSystemMessage('AI Explanation: ' + data.explanation);
            }
        } catch (error) {
            console.error('Error getting explanation:', error);
        }
    } else {
        // Handle positive/negative feedback
        btn.textContent = feedback === 'positive' ? '✓' : '✗';
        btn.disabled = true;
        
        // Disable other feedback buttons
        btn.parentElement.querySelectorAll('.feedback-btn').forEach(b => {
            if (b !== btn && !b.classList.contains('explain-btn')) {
                b.disabled = true;
            }
        });
        
        addSystemMessage(`Feedback recorded: ${feedback === 'positive' ? 'helpful' : 'not helpful'}`);
    }
}

async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    
    addUserMessage(message);
    chatInput.value = '';
    
    // Disable send button
    sendBtn.disabled = true;
    sendBtn.textContent = 'Thinking...';
    
    try {
        if (socket && socket.connected) {
            // Use WebSocket
            socket.emit('message', { text: message });
        } else {
            // Use REST API
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: message,
                    max_tokens: parseInt(document.getElementById('max-tokens').value),
                    temperature: parseFloat(document.getElementById('temperature').value)
                })
            });
            
            const data = await response.json();
            if (data.success) {
                addAIMessage(data.response);
            } else {
                addSystemMessage('Error: ' + data.error);
            }
        }
    } catch (error) {
        addSystemMessage('Error: ' + error.message);
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
    }
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);

chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

clearBtn.addEventListener('click', () => {
    chatBox.innerHTML = '<div class="chat-message system"><p>Chat cleared</p></div>';
});

// Load AI mood on page load
loadChatMood();
</script>

<style>
.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.chat-header h2 {
    margin: 0;
}

.chat-header .ai-mood {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--light);
    border-radius: 8px;
}

.message-feedback {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.feedback-btn {
    padding: 0.25rem 0.5rem;
    border: none;
    background: var(--light);
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
}

.feedback-btn:hover:not(:disabled) {
    background: var(--border);
    transform: scale(1.1);
}

.feedback-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}
